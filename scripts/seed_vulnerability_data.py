"""
Script to seed vulnerability and compliance databases.
"""

import asyncio
from datetime import datetime, timedelta
import logging
import os
import sys
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker, create_async_engine
from dotenv import load_dotenv

# Add project root to Python path
project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, project_root)

# Load environment variables
load_dotenv()

from src.db.postgres.models import Framework, Vulnerability, Control, ComplianceRequirement
from src.services.compliance.vulnerability_data import CVEDataFetcher, OWASPDataFetcher, CISDataFetcher

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Create async session maker
database_url = os.getenv("DATABASE_URL", "postgresql://scanner_user:postgres@localhost:5432/security_scanner")
database_url = database_url.replace("postgresql://", "postgresql+asyncpg://")

engine = create_async_engine(database_url)
AsyncSessionLocal = async_sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)

async def seed_frameworks(session: AsyncSession) -> dict:
    """Seed security frameworks."""
    frameworks_data = [
        Framework(
            name="NIST",
            version="1.0",
            description="National Institute of Standards and Technology Vulnerability Database"
        ),
        Framework(
            name="OWASP",
            version="2021",
            description="OWASP Top 10 Web Application Security Risks"
        ),
        Framework(
            name="CIS",
            version="8.0",
            description="Center for Internet Security Controls"
        )
    ]
    
    # Check for existing frameworks
    result = await session.execute(
        select(Framework).where(Framework.name.in_([f.name for f in frameworks_data]))
    )
    existing_frameworks = {f.name: f for f in result.scalars()}
    
    framework_dict = {}
    
    # Add new frameworks
    for framework in frameworks_data:
        if framework.name not in existing_frameworks:
            session.add(framework)
            await session.flush()
            await session.refresh(framework)
            framework_dict[framework.name] = framework
        else:
            framework_dict[framework.name] = existing_frameworks[framework.name]
    
    return framework_dict

async def seed_owasp_controls(session: AsyncSession, framework_id: int):
    """Seed OWASP controls and requirements."""
    owasp_data = OWASPDataFetcher.get_owasp_controls()
    
    for control_id, data in owasp_data.items():
        control = Control(
            framework_id=framework_id,
            control_id=control_id,
            title=data['title'],
            description=data['description'],
            category='OWASP Top 10 2021',
            severity='High'
        )
        session.add(control)
        await session.flush()
        
        # Add compliance requirements
        for idx, requirement in enumerate(data['controls'], 1):
            req = ComplianceRequirement(
                framework_id=framework_id,
                requirement_id=f"{control_id}.{idx}",
                title=requirement,
                description=requirement,
                category=data['title'],
                priority='Must'
            )
            session.add(req)
            await session.flush()

async def seed_cis_controls(session: AsyncSession, framework_id: int):
    """Seed CIS controls and requirements."""
    cis_data = CISDataFetcher.get_cis_controls()
    
    for control_id, data in cis_data.items():
        control = Control(
            framework_id=framework_id,
            control_id=control_id,
            title=data['title'],
            description=data['description'],
            category='CIS Controls v8',
            severity='High'
        )
        session.add(control)
        await session.flush()
        
        # Add compliance requirements
        for idx, requirement in enumerate(data['controls'], 1):
            req = ComplianceRequirement(
                framework_id=framework_id,
                requirement_id=f"{control_id}.{idx}",
                title=requirement,
                description=requirement,
                category=data['title'],
                priority='Must'
            )
            session.add(req)
            await session.flush()

async def seed_recent_cves(session: AsyncSession, framework_id: int):
    """Seed recent CVEs from NVD."""
    fetcher = CVEDataFetcher()
    
    # Fetch last 30 days of CVEs
    start_date = datetime.utcnow() - timedelta(days=30)
    cves = await fetcher.fetch_nvd_cves(start_date=start_date)
    
    for cve_data in cves:
        vuln = Vulnerability(
            framework_id=framework_id,
            cve_id=cve_data['cve_id'],
            title=cve_data['title'],
            description=cve_data['description'],
            severity=cve_data['severity'],
            cvss_score=cve_data['cvss_score'],
            cvss_vector=cve_data['cvss_vector'],
            published_date=datetime.fromisoformat(cve_data['published_date'].replace('Z', '+00:00')),
            last_modified_date=datetime.fromisoformat(cve_data['last_modified_date'].replace('Z', '+00:00')),
            affected_products=cve_data['affected_products'],
            references=cve_data['references'],
            extra_data=cve_data['metadata']
        )
        session.add(vuln)
        await session.flush()

async def main():
    """Main seeding function."""
    logger.info("Starting database seeding...")
    
    async with AsyncSessionLocal() as session:
        async with session.begin():
            try:
                # Seed frameworks
                frameworks = await seed_frameworks(session)
                logger.info("Frameworks seeded successfully")
                
                # Seed OWASP controls
                await seed_owasp_controls(session, frameworks['OWASP'].id)
                logger.info("OWASP controls seeded successfully")
                
                # Seed CIS controls
                await seed_cis_controls(session, frameworks['CIS'].id)
                logger.info("CIS controls seeded successfully")
                
                # Seed recent CVEs
                await seed_recent_cves(session, frameworks['NIST'].id)
                logger.info("Recent CVEs seeded successfully")
                
                logger.info("Database seeding completed successfully")
                
            except Exception as e:
                logger.error(f"Error seeding database: {e}")
                raise

if __name__ == "__main__":
    asyncio.run(main())