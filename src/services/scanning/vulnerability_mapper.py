from typing import Dict, List, Any
from sqlalchemy.orm import Session
from sqlalchemy import or_

from src.db.postgres.models import Vulnerability, Control
from src.core.logging import get_logger

logger = get_logger(__name__)

class VulnerabilityMapper:
    def __init__(self, db: Session):
        self.db = db
        
    def map_bandit_finding(self, finding: Dict[str, Any]) -> List[Dict[str, Any]]:
        """
        Map Bandit findings to known vulnerabilities in our database.
        
        Args:
            finding: A finding from Bandit scanner
            
        Returns:
            List of matched vulnerabilities with confidence scores
        """
        matches = []
        
        # Extract key information from finding
        issue_type = finding.get("type", "")
        description = finding.get("description", "")
        severity = finding.get("severity", "LOW").upper()
        
        # Common vulnerability patterns
        if "sql" in issue_type.lower() or "sql" in description.lower():
            pattern = "SQL injection"
        elif "command" in issue_type.lower() or "subprocess" in description.lower():
            pattern = "Command injection"
        elif "crypto" in issue_type.lower() or "random" in description.lower():
            pattern = "Cryptographic issues"
        elif "password" in issue_type.lower() or "secret" in description.lower():
            pattern = "Credential exposure"
        else:
            pattern = issue_type
            
        # Search for matching vulnerabilities
        vulnerabilities = self.db.query(Vulnerability).filter(
            or_(
                Vulnerability.title.ilike(f"%{pattern}%"),
                Vulnerability.description.ilike(f"%{pattern}%")
            )
        ).all()
        
        for vuln in vulnerabilities:
            # Calculate confidence score based on similarity
            confidence = self._calculate_confidence(
                finding=finding,
                vulnerability=vuln
            )
            
            if confidence > 0.5:  # Only include reasonably confident matches
                matches.append({
                    "vulnerability_id": vuln.id,
                    "cve_id": vuln.cve_id,
                    "confidence": confidence,
                    "severity": severity
                })
        
        return matches
    
    def map_semgrep_finding(self, finding: Dict[str, Any]) -> List[Dict[str, Any]]:
        """
        Map Semgrep findings to known vulnerabilities in our database.
        
        Args:
            finding: A finding from Semgrep scanner
            
        Returns:
            List of matched vulnerabilities with confidence scores
        """
        matches = []
        
        # Extract key information from finding
        rule_id = finding.get("rule_id", "")
        message = finding.get("message", "")
        severity = finding.get("severity", "LOW").upper()
        
        # Search for matching vulnerabilities
        vulnerabilities = self.db.query(Vulnerability).filter(
            or_(
                Vulnerability.title.ilike(f"%{rule_id}%"),
                Vulnerability.description.ilike(f"%{message}%")
            )
        ).all()
        
        for vuln in vulnerabilities:
            # Calculate confidence score
            confidence = self._calculate_confidence(
                finding=finding,
                vulnerability=vuln,
                is_semgrep=True
            )
            
            if confidence > 0.5:
                matches.append({
                    "vulnerability_id": vuln.id,
                    "cve_id": vuln.cve_id,
                    "confidence": confidence,
                    "severity": severity
                })
        
        return matches
    
    def map_to_controls(self, vulnerability_id: int) -> List[Dict[str, Any]]:
        """
        Map a vulnerability to relevant security controls.
        
        Args:
            vulnerability_id: ID of the vulnerability
            
        Returns:
            List of relevant controls with confidence scores
        """
        # Get the vulnerability
        vulnerability = self.db.query(Vulnerability).filter(
            Vulnerability.id == vulnerability_id
        ).first()
        
        if not vulnerability:
            return []
            
        # Find relevant controls
        controls = self.db.query(Control).all()
        matches = []
        
        for control in controls:
            # Calculate relevance score
            relevance = self._calculate_control_relevance(
                vulnerability=vulnerability,
                control=control
            )
            
            if relevance > 0.5:
                matches.append({
                    "control_id": control.id,
                    "framework_id": control.framework_id,
                    "relevance": relevance,
                    "mitigation_advice": control.description
                })
        
        return matches
    
    def _calculate_confidence(
        self,
        finding: Dict[str, Any],
        vulnerability: Vulnerability,
        is_semgrep: bool = False
    ) -> float:
        """Calculate confidence score for a vulnerability match"""
        confidence = 0.0
        
        # Basic text matching
        if is_semgrep:
            rule_id = finding.get("rule_id", "").lower()
            message = finding.get("message", "").lower()
            if rule_id in vulnerability.title.lower():
                confidence += 0.4
            if any(word in vulnerability.description.lower() 
                  for word in message.split()):
                confidence += 0.3
        else:
            issue_type = finding.get("type", "").lower()
            description = finding.get("description", "").lower()
            if issue_type in vulnerability.title.lower():
                confidence += 0.4
            if any(word in vulnerability.description.lower() 
                  for word in description.split()):
                confidence += 0.3
                
        # Severity matching
        if finding.get("severity", "").upper() == vulnerability.severity:
            confidence += 0.3
            
        return min(confidence, 1.0)
    
    def _calculate_control_relevance(
        self,
        vulnerability: Vulnerability,
        control: Control
    ) -> float:
        """Calculate relevance score for a control match"""
        relevance = 0.0
        
        # Category matching
        if control.category and control.category.lower() in vulnerability.title.lower():
            relevance += 0.4
            
        # Description matching
        if any(word in control.description.lower() 
              for word in vulnerability.description.lower().split()):
            relevance += 0.3
            
        # Severity matching
        if vulnerability.severity == control.severity:
            relevance += 0.3
            
        return min(relevance, 1.0)